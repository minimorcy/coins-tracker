<c-modal [visible]="visible" (visibleChange)="handleVisibleChange($event)" size="xl">
  <c-modal-header>
    <h5 cModalTitle>Trade Setup Analysis: {{ cryptoName }}</h5>
  </c-modal-header>
  <c-modal-body *ngIf="analysisData">
    <div class="d-flex justify-content-center mb-4">
      <div class="w-100 p-4 rounded text-center border"
           [ngClass]="{
             'bg-success-subtle border-success text-success-emphasis': analysisData.state === 'bullish',
             'bg-danger-subtle border-danger text-danger-emphasis': analysisData.state === 'bearish',
             'bg-secondary-subtle border-secondary text-secondary-emphasis': !analysisData.state
           }">
        <h2 class="m-0 fw-bold">
          {{ analysisData.state ? (analysisData.state | uppercase) + ' SETUP DETECTED' : 'NO CLEAR SETUP' }}
        </h2>
        <div class="mt-2 fs-5" *ngIf="analysisData.state">
          Confidence: High | Ready for Trade Plan
        </div>
      </div>
    </div>

    <c-row>
      <!-- Daily Analysis -->
      <c-col md="6">
        <c-card class="h-100 bg-body-tertiary">
          <c-card-body>
            <h5 class="card-title mb-3">Daily Timeframe (Trend)</h5>
            <div class="mb-2">
              <strong>Price:</strong> {{ analysisData.daily.price | currency }}
            </div>
            <div class="mb-2">
              <strong>EMA 50:</strong> {{ analysisData.daily.ema50 | currency }}
            </div>
            <div class="mt-3 p-2 rounded text-center text-white"
                 [ngClass]="{
                   'bg-success': analysisData.daily.trend === 'bullish',
                   'bg-danger': analysisData.daily.trend === 'bearish',
                   'bg-secondary': analysisData.daily.trend === 'neutral'
                 }">
              Trend (Daily): {{ analysisData.daily.trend | uppercase }}
            </div>
          </c-card-body>
        </c-card>
      </c-col>

      <!-- 1h Analysis -->
      <c-col md="6">
        <c-card class="h-100 bg-body-tertiary">
          <c-card-body>
            <h5 class="card-title mb-3">1h Timeframe (Entry)</h5>
            <div class="mb-2">
              <strong>Price:</strong> {{ analysisData.hourly.price | currency }}
            </div>
            <div class="mb-2">
              <strong>EMA 50:</strong> {{ analysisData.hourly.ema50 | currency }}
            </div>
            <div class="mt-3 p-2 rounded text-center text-white"
                 [ngClass]="{
                   'bg-success': analysisData.hourly.touched,
                   'bg-secondary': !analysisData.hourly.touched
                 }">
              Touched EMA50: {{ analysisData.hourly.touched ? 'YES' : 'NO' }}
              <span *ngIf="analysisData.hourly.touched" class="fw-bold ms-1">
                {{ analysisData.hourly.price > analysisData.hourly.ema50 ? '‚Üë' : '‚Üì' }}
              </span>
            </div>
            
            <hr class="my-3">
            
            <div class="row g-2 mb-2">
                <div class="col-6">
                    <div class="p-2 border rounded bg-dark-subtle">
                        <small class="text-secondary d-block">RSI (14)</small>
                        <span class="fw-bold" [ngClass]="{
                          'text-success': analysisData.hourly.rsi < 30,
                          'text-danger': analysisData.hourly.rsi > 70,
                          'text-warning': analysisData.hourly.rsi >= 30 && analysisData.hourly.rsi <= 70
                        }">{{ analysisData.hourly.rsi | number:'1.1-1' }}</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-2 border rounded bg-dark-subtle">
                        <small class="text-secondary d-block">Stoch RSI</small>
                        <span class="fw-bold" [ngClass]="{
                             'text-success': analysisData.hourly.stochRsi.k < 20, 
                             'text-danger': analysisData.hourly.stochRsi.k > 80
                           }">
                             K: {{ analysisData.hourly.stochRsi.k | number:'1.0-0' }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="mb-2 mt-3">
              <strong>Volume: </strong> 
              <span [ngClass]="{
                'text-success': analysisData.hourly.volume.status === 'high',
                'text-danger': analysisData.hourly.volume.status === 'low'
              }">{{ analysisData.hourly.volume.status | titlecase }}</span>
            </div>
            <div class="mb-2">
              <strong>ATR (14): </strong> {{ analysisData.hourly.atr | number:'1.4-4' }}
            </div>
            <div class="mb-2">
              <strong>ADX (14): </strong> 
              <span [ngClass]="{
                'text-success': analysisData.hourly.adx.strength === 'strong',
                'text-secondary': analysisData.hourly.adx.strength === 'weak'
              }">{{ analysisData.hourly.adx.value | number:'1.2-2' }} ({{ analysisData.hourly.adx.strength | titlecase }})</span>
            </div>

            <div *ngIf="analysisData.hourly.patterns.length > 0" class="mb-2">
              <strong>Patterns: </strong>
              <span class="badge bg-info ms-1" *ngFor="let p of analysisData.hourly.patterns">{{ p }}</span>
            </div>

            <div *ngIf="analysisData.hourly.divergence" class="mb-2">
              <strong>Divergence: </strong>
              <span class="badge" [ngClass]="{
                'bg-success': analysisData.hourly.divergence === 'bullish',
                'bg-danger': analysisData.hourly.divergence === 'bearish'
              }">{{ analysisData.hourly.divergence | titlecase }}</span>
            </div>

            <div *ngIf="analysisData.state" class="mt-3 p-3 rounded border border-secondary bg-dark-subtle">
              <div class="small fw-bold mb-2">Trade Plan</div>
              <div class="d-flex justify-content-between">
                <span class="text-danger">SL: {{ analysisData.hourly.stopLoss | currency }}</span>
                <span class="text-success">TP: {{ analysisData.hourly.takeProfit | currency }}</span>
              </div>
            </div>

          </c-card-body>
        </c-card>
      </c-col>
    </c-row>

    <!-- Cava Strategy Section -->
    <div class="mt-4 pt-4 border-top" *ngIf="analysisData.cava">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold text-purple mb-0" style="color: #6f42c1;">üß† AN√ÅLISIS CAVA (H√çBRIDO)</h6>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <div class="p-3 border rounded bg-body-tertiary">
            <div class="d-flex justify-content-between mb-1">
              <span>MACD Diario:</span>
              <span [ngClass]="{'text-success': analysisData.cava.macdDaily.macd > analysisData.cava.macdDaily.signal, 'text-danger': analysisData.cava.macdDaily.macd <= analysisData.cava.macdDaily.signal}">
                {{ analysisData.cava.macdDaily.macd > analysisData.cava.macdDaily.signal ? 'ALCISTA' : 'BAJISTA' }}
              </span>
            </div>
            <div class="small text-secondary">Filtro de Tendencia</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 border rounded bg-body-tertiary">
            <div class="d-flex justify-content-between mb-1">
              <span>Stoch (50):</span>
              <span [ngClass]="{'text-success': analysisData.cava.stochSlow.k > 80, 'text-danger': analysisData.cava.stochSlow.k <= 20, 'text-warning': analysisData.cava.stochSlow.k > 20 && analysisData.cava.stochSlow.k <= 80}">
                {{ analysisData.cava.stochSlow.k | number:'1.0-0' }}
              </span>
            </div>
            <div class="small text-secondary">Fuerza (>80 es bueno)</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 border rounded bg-body-tertiary">
            <div class="d-flex justify-content-between mb-1">
              <span>RSI (2):</span>
              <span [ngClass]="{'text-success': analysisData.cava.rsi2 < 10, 'text-danger': analysisData.cava.rsi2 > 90, 'text-warning': analysisData.cava.rsi2 >= 10 && analysisData.cava.rsi2 <= 90}">
                {{ analysisData.cava.rsi2 | number:'1.1-1' }}
              </span>
            </div>
            <div class="small text-secondary">Entrada (<10 o >90)</div>
          </div>
        </div>
      </div>
      
      <div class="mt-3 p-2 rounded text-center text-white fw-bold"
           [ngClass]="{
             'bg-purple': analysisData.cava.setup,
             'bg-secondary': !analysisData.cava.setup
           }" style="background-color: #6f42c1;">
        ESTADO CAVA: {{ analysisData.cava.setup ? (analysisData.cava.state | uppercase) : 'NO SE√ëAL' }}
      </div>
      <div class="mt-2 small text-secondary">
        Requiere: MACD Diario alineado + Stoch(50) > 80 + RSI(2) extremo
      </div>
    </div>

    <!-- Strategy Details Accordion -->
    <div class="mt-4">
      <div class="accordion accordion-flush">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" [class.collapsed]="!accordionVisible" type="button" (click)="toggleAccordion()">
              üìä Detalles Completos de la Estrategia Experta
            </button>
          </h2>
          <div class="accordion-collapse collapse" [class.show]="accordionVisible">
            <div class="accordion-body">
              <div class="p-3">
                <!-- Estado General -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">üìà ESTADO GENERAL</h6>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <small class="text-secondary d-block mb-1">Setup Detectado</small>
                        <span class="fw-bold fs-5" [ngClass]="{
                          'text-success': analysisData.state === 'bullish',
                          'text-danger': analysisData.state === 'bearish',
                          'text-secondary': !analysisData.state
                        }">{{ analysisData.state ? (analysisData.state | uppercase) : 'NO DETECTADO' }}</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <small class="text-secondary d-block mb-1">Alineaci√≥n de Tendencias</small>
                        <span class="fw-bold" [ngClass]="{
                          'text-success': analysisData.daily.trend === analysisData.fourHour.trend && analysisData.daily.trend !== 'neutral',
                          'text-danger': analysisData.daily.trend !== analysisData.fourHour.trend || analysisData.daily.trend === 'neutral'
                        }">
                          {{ (analysisData.daily.trend === analysisData.fourHour.trend && analysisData.daily.trend !== 'neutral') ? '‚úÖ ALINEADAS' : '‚ùå NO ALINEADAS' }}
                        </span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <small class="text-secondary d-block mb-1">Distancia a EMA50</small>
                        <span class="fw-bold" [ngClass]="{
                          'text-success': analysisData.hourly.touched,
                          'text-warning': !analysisData.hourly.touched
                        }">
                          {{ analysisData.hourly.touched ? 'YES' : 'NO' }}
                        </span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <strong>4H Timeframe</strong>
                          <span class="fs-4">{{ getTrendIcon(analysisData.fourHour.trend) }}</span>
                        </div>
                        <div class="mb-2"><small class="text-secondary">Tendencia:</small> 
                          <span class="badge" [ngClass]="{
                            'bg-success': analysisData.fourHour.trend === 'bullish',
                            'bg-danger': analysisData.fourHour.trend === 'bearish',
                            'bg-secondary': analysisData.fourHour.trend === 'neutral'
                          }">{{ analysisData.fourHour.trend | uppercase }}</span>
                        </div>
                        <div class="alert alert-info mb-0 py-2 px-3" role="alert">
                          <small>‚úì Requisito: Debe coincidir con Daily para validar setup</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Indicadores T√©cnicos -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">2Ô∏è‚É£ INDICADORES T√âCNICOS (1H)</h6>
                  <div class="row g-3">
                    <div class="col-md-3">
                      <div class="p-3 border rounded bg-body-tertiary text-center">
                        <small class="text-secondary d-block mb-2">RSI (14)</small>
                        <div class="fs-3 fw-bold mb-2" [ngClass]="{
                          'text-success': analysisData.hourly.rsi < 30,
                          'text-danger': analysisData.hourly.rsi > 70,
                          'text-warning': analysisData.hourly.rsi >= 30 && analysisData.hourly.rsi <= 70
                        }">{{ analysisData.hourly.rsi | number:'1.1-1' }}</div>
                        <small class="text-secondary">
                          <span *ngIf="analysisData.hourly.rsi < 30">Sobreventa</span>
                          <span *ngIf="analysisData.hourly.rsi > 70">Sobrecompra</span>
                          <span *ngIf="analysisData.hourly.rsi >= 30 && analysisData.hourly.rsi <= 70">Neutral</span>
                        </small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 border rounded bg-body-tertiary text-center">
                        <small class="text-secondary d-block mb-2">Stochastic RSI</small>
                        <div class="mb-2">
                          <span class="fw-bold fs-5" [ngClass]="{
                            'text-success': analysisData.hourly.stochRsi.k < 20,
                            'text-danger': analysisData.hourly.stochRsi.k > 80
                          }">K: {{ analysisData.hourly.stochRsi.k | number:'1.0-0' }}</span>
                        </div>
                        <div>
                          <small class="text-secondary">D: {{ analysisData.hourly.stochRsi.d | number:'1.0-0' }}</small>
                        </div>
                        <small class="text-secondary d-block mt-2">
                          <span *ngIf="analysisData.hourly.stochRsi.k < 20">Oversold ‚úì</span>
                          <span *ngIf="analysisData.hourly.stochRsi.k > 80">Overbought ‚úì</span>
                          <span *ngIf="analysisData.hourly.stochRsi.k >= 20 && analysisData.hourly.stochRsi.k <= 80">
                            {{ analysisData.hourly.stochRsi.k > analysisData.hourly.stochRsi.d ? 'K > D ‚Üë' : 'K < D ‚Üì' }}
                          </span>
                        </small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 border rounded bg-body-tertiary text-center">
                        <small class="text-secondary d-block mb-2">MACD</small>
                        <div class="mb-1">
                          <span class="fw-bold" [ngClass]="{
                            'text-success': analysisData.hourly.macd.histogram > 0,
                            'text-danger': analysisData.hourly.macd.histogram < 0
                          }">Hist: {{ analysisData.hourly.macd.histogram | number:'1.4-4' }}</span>
                        </div>
                        <div class="mb-1"><small class="text-secondary">MACD: {{ analysisData.hourly.macd.macd | number:'1.4-4' }}</small></div>
                        <div><small class="text-secondary">Signal: {{ analysisData.hourly.macd.signal | number:'1.4-4' }}</small></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 border rounded bg-body-tertiary text-center">
                        <small class="text-secondary d-block mb-2">ADX (14)</small>
                        <div class="fs-3 fw-bold mb-2" [ngClass]="{
                          'text-success': analysisData.hourly.adx.value > 25,
                          'text-warning': analysisData.hourly.adx.value >= 20 && analysisData.hourly.adx.value <= 25,
                          'text-secondary': analysisData.hourly.adx.value < 20
                        }">{{ analysisData.hourly.adx.value | number:'1.1-1' }}</div>
                        <small class="text-secondary">{{ analysisData.hourly.adx.strength | titlecase }}</small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Volumen y Volatilidad -->
                <div class="mb-4">
                  <h6 class="fw-bold text-primary mb-3">3Ô∏è‚É£ VOLUMEN Y VOLATILIDAD</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <strong class="d-block mb-2">An√°lisis de Volumen</strong>
                        <div class="mb-1"><small class="text-secondary">Volumen Actual:</small> <strong>{{ analysisData.hourly.volume.current | number:'1.0-0' }}</strong></div>
                        <div class="mb-1"><small class="text-secondary">Promedio (20):</small> <strong>{{ analysisData.hourly.volume.average | number:'1.0-0' }}</strong></div>
                        <div class="mt-2">
                          <span class="badge" [ngClass]="{
                            'bg-success': analysisData.hourly.volume.status === 'high',
                            'bg-danger': analysisData.hourly.volume.status === 'low',
                            'bg-secondary': analysisData.hourly.volume.status === 'normal'
                          }">{{ analysisData.hourly.volume.status | uppercase }}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <strong class="d-block mb-2">Average True Range (ATR)</strong>
                        <div class="fs-4 fw-bold text-info mb-2">{{ analysisData.hourly.atr | number:'1.6-6' }}</div>
                        <small class="text-secondary">Usado para calcular Stop Loss (1.5x ATR)</small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Patrones y Divergencias -->
                <div class="mb-4" *ngIf="analysisData.hourly.patterns.length > 0 || analysisData.hourly.divergence">
                  <h6 class="fw-bold text-primary mb-3">4Ô∏è‚É£ PATRONES Y SE√ëALES</h6>
                  <div class="row g-3">
                    <div class="col-md-6" *ngIf="analysisData.hourly.patterns.length > 0">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <strong class="d-block mb-2">Patrones de Velas</strong>
                        <div>
                          <span class="badge bg-info me-1 mb-1" *ngFor="let p of analysisData.hourly.patterns">{{ p }}</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6" *ngIf="analysisData.hourly.divergence">
                      <div class="p-3 border rounded bg-body-tertiary">
                        <strong class="d-block mb-2">Divergencia RSI</strong>
                        <span class="badge fs-6" [ngClass]="{
                          'bg-success': analysisData.hourly.divergence === 'bullish',
                          'bg-danger': analysisData.hourly.divergence === 'bearish'
                        }">{{ analysisData.hourly.divergence | titlecase }} Divergence</span>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </c-modal-body>
  <c-modal-footer>
    <button (click)="handleVisibleChange(false)" cButton color="secondary">Close</button>
  </c-modal-footer>
</c-modal>
