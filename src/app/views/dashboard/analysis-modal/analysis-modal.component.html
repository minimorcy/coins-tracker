<c-modal [visible]="visible" (visibleChange)="handleVisibleChange($event)" size="lg">
  <c-modal-header>
    <h5 cModalTitle>Trade Setup Analysis: {{ cryptoName }}</h5>
  </c-modal-header>
  <c-modal-body *ngIf="analysisData">
    <div class="d-flex justify-content-center mb-4">
      <span class="badge p-3 fs-5"
            [ngClass]="{
              'bg-success': analysisData.state === 'bullish',
              'bg-danger': analysisData.state === 'bearish',
              'bg-secondary': !analysisData.state
            }">
        Result: {{ analysisData.state ? (analysisData.state | titlecase) + ' Setup' : 'No Setup' }}
      </span>
    </div>

    <c-row>
      <!-- Daily Analysis -->
      <c-col md="6">
        <c-card class="h-100">
          <c-card-body>
            <h5 class="card-title mb-3">Daily Timeframe (Trend)</h5>
            <div class="mb-2">
              <strong>Price:</strong> {{ analysisData.daily.price | currency }}
            </div>
            <div class="mb-2">
              <strong>EMA 50:</strong> {{ analysisData.daily.ema50 | currency }}
            </div>
            <div class="mt-3 p-2 rounded text-center text-white"
                 [ngClass]="{
                   'bg-success': analysisData.daily.trend === 'bullish',
                   'bg-danger': analysisData.daily.trend === 'bearish',
                   'bg-secondary': analysisData.daily.trend === 'neutral'
                 }">
              Trend (Daily): {{ analysisData.daily.trend | uppercase }}
            </div>
            <div class="mt-2 p-2 rounded text-center text-white"
                 [ngClass]="{
                   'bg-success': analysisData.fourHour.trend === 'bullish',
                   'bg-danger': analysisData.fourHour.trend === 'bearish',
                   'bg-secondary': analysisData.fourHour.trend === 'neutral'
                 }">
              Trend (4H): {{ analysisData.fourHour.trend | uppercase }}
            </div>
            <div class="mt-2 small text-muted">
              Condition: Price vs EMA50 & EMA Slope
            </div>
          </c-card-body>
        </c-card>
      </c-col>

      <!-- Hourly Analysis -->
      <c-col md="6">
        <c-card class="h-100">
          <c-card-body>
            <h5 class="card-title mb-3">1h Timeframe (Entry)</h5>
            <div class="mb-2">
              <strong>Price:</strong> {{ analysisData.hourly.price | currency }}
            </div>
            <div class="mb-2">
              <strong>EMA 50:</strong> {{ analysisData.hourly.ema50 | currency }}
            </div>
            <div class="mt-3 p-2 rounded text-center text-white"
                 [ngClass]="{
                   'bg-success': analysisData.hourly.touched,
                   'bg-secondary': !analysisData.hourly.touched
                 }">
              Touched EMA50: {{ analysisData.hourly.touched ? 'YES' : 'NO' }}
            </div>
            
            <hr class="my-3">
            
            <div class="mb-2">
              <strong>RSI (14):</strong> 
              <span [ngClass]="{
                'text-success': analysisData.hourly.rsi < 30,
                'text-danger': analysisData.hourly.rsi > 70,
                'text-warning': analysisData.hourly.rsi >= 30 && analysisData.hourly.rsi <= 70
              }">{{ analysisData.hourly.rsi | number:'1.2-2' }}</span>
            </div>
            <div class="mb-2">
              <strong>Volume:</strong> 
              <span [ngClass]="{
                'text-success': analysisData.hourly.volume.status === 'high',
                'text-danger': analysisData.hourly.volume.status === 'low'
              }">{{ analysisData.hourly.volume.status | titlecase }}</span>
            </div>
            <div class="mb-2">
              <strong>ATR (14):</strong> {{ analysisData.hourly.atr | number:'1.4-4' }}
            </div>
            <div class="mb-2">
              <strong>ADX (14):</strong> 
              <span [ngClass]="{
                'text-success': analysisData.hourly.adx.strength === 'strong',
                'text-muted': analysisData.hourly.adx.strength === 'weak'
              }">{{ analysisData.hourly.adx.value | number:'1.2-2' }} ({{ analysisData.hourly.adx.strength | titlecase }})</span>
            </div>

            <div *ngIf="analysisData.hourly.patterns.length > 0" class="mb-2">
              <strong>Patterns:</strong>
              <span class="badge bg-info ms-1" *ngFor="let p of analysisData.hourly.patterns">{{ p }}</span>
            </div>

            <div *ngIf="analysisData.hourly.divergence" class="mb-2">
              <strong>Divergence:</strong>
              <span class="badge" [ngClass]="{
                'bg-success': analysisData.hourly.divergence === 'bullish',
                'bg-danger': analysisData.hourly.divergence === 'bearish'
              }">{{ analysisData.hourly.divergence | titlecase }}</span>
            </div>

            <div *ngIf="analysisData.state" class="mt-3 p-2 bg-light rounded border">
              <div class="small fw-bold text-muted mb-1">Trade Plan</div>
              <div class="d-flex justify-content-between">
                <span class="text-danger">SL: {{ analysisData.hourly.stopLoss | currency }}</span>
                <span class="text-success">TP: {{ analysisData.hourly.takeProfit | currency }}</span>
              </div>
            </div>

          </c-card-body>
        </c-card>
      </c-col>
    </c-row>
  </c-modal-body>
  <c-modal-footer>
    <button (click)="handleVisibleChange(false)" cButton color="secondary">Close</button>
  </c-modal-footer>
</c-modal>
