<c-row class="mb-4" *ngIf="globalData">
  <c-col xs>
    <c-card class="bg-dark text-white">
      <c-card-body class="d-flex justify-content-around align-items-center py-2">
        <div>
          <small class="text-muted d-block">Market Cap</small>
          <span class="fw-bold">{{ globalData.total_market_cap['usd'] | currency:'USD':'symbol':'1.0-0' }}</span>
          <span [class.text-success]="globalData.market_cap_change_percentage_24h_usd >= 0" 
                [class.text-danger]="globalData.market_cap_change_percentage_24h_usd < 0"
                class="ms-1 small">
            {{ globalData.market_cap_change_percentage_24h_usd | number:'1.1-2' }}%
          </span>
        </div>
        <div>
          <small class="text-muted d-block">24h Volume</small>
          <span class="fw-bold">{{ globalData.total_volume['usd'] | currency:'USD':'symbol':'1.0-0' }}</span>
        </div>
        <div>
          <small class="text-muted d-block">BTC Dominance</small>
          <span class="fw-bold">{{ globalData.market_cap_percentage['btc'] | number:'1.1-1' }}%</span>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-row class="mb-4" *ngIf="showPortfolioFeatures">
  <c-col xs>
    <c-card class="bg-primary text-white">
      <c-card-body class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Total Portfolio Value</h4>
          <small>Real-time valuation based on your holdings</small>
        </div>
        <div class="text-end">
          <h2 class="mb-0">{{ totalPortfolioValue | currency }}</h2>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-row>
  <c-col xs>
    <c-card class="mb-4">
      <c-card-header>
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div class="d-flex align-items-center flex-grow-1 flex-wrap gap-3">
            <span class="me-2 text-nowrap fw-bold">Crypto Prices</span>
            
            <!-- Search -->
            <div class="input-group input-group-sm" style="max-width: 200px;">
              <span class="input-group-text">üîç</span>
              <input type="text" class="form-control" placeholder="Search..." [(ngModel)]="searchTerm">
            </div>

            <!-- Add Coin -->
            <div class="input-group input-group-sm" style="max-width: 200px;">
              <input type="text" class="form-control" placeholder="Symbol (e.g. DOGE)" [(ngModel)]="newCoinSymbol" (keyup.enter)="addCoin()">
              <button cButton color="success" size="sm" (click)="addCoin()" [disabled]="!newCoinSymbol">Add</button>
            </div>

            <c-form-check switch class="mb-0" *ngIf="showPortfolioFeatures">
              <input cFormCheckInput type="checkbox" [(ngModel)]="showPortfolioOnly" id="portfolioOnlySwitch"/>
              <label cFormCheckLabel for="portfolioOnlySwitch" class="small text-muted text-nowrap">Portfolio Only</label>
            </c-form-check>

            <c-form-check switch class="mb-0">
              <input cFormCheckInput type="checkbox" [(ngModel)]="showPortfolioFeatures" id="portfolioFeaturesSwitch"/>
              <label cFormCheckLabel for="portfolioFeaturesSwitch" class="small text-muted text-nowrap">Enable Portfolio</label>
            </c-form-check>

            <c-form-check switch class="mb-0">
              <input cFormCheckInput type="checkbox" [(ngModel)]="autoRefreshEnabled" (change)="toggleAutoRefresh()" id="autoRefreshSwitch"/>
              <label cFormCheckLabel for="autoRefreshSwitch" class="small text-muted text-nowrap">Auto-refresh</label>
            </c-form-check>
          </div>
          <button cButton color="primary" size="sm" (click)="refreshData()">Refresh</button>
        </div>
      </c-card-header>
      <c-card-body>
        <table cTable hover>
          <thead>
            <tr>
              <th>#</th>
              <th (click)="sort('name')" class="sortable-header">Coin {{ getSortIcon('name') }}</th>
              <th (click)="sort('lastPrice')" class="sortable-header">Price {{ getSortIcon('lastPrice') }}</th>
              <th (click)="sort('priceChangePercent')" class="sortable-header">24h Change {{ getSortIcon('priceChangePercent') }}</th>
              <th (click)="sort('dailyChangePercent')" class="sortable-header">Day Change (00:00) {{ getSortIcon('dailyChangePercent') }}</th>
              <th *ngIf="showPortfolioFeatures" (click)="sort('holdings')" class="sortable-header" style="width: 150px;">Holdings {{ getSortIcon('holdings') }}</th>
              <th *ngIf="showPortfolioFeatures" (click)="sort('value')" class="sortable-header">Value {{ getSortIcon('value') }}</th>
              <th style="width: 50px;"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let crypto of filteredCryptocurrencies; let i = index" 
                class="clickable-row" 
                [class.has-holdings]="(crypto.holdings || 0) > 0"
                (click)="openChart(crypto)">
              <td class="text-muted">{{ i + 1 }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <span class="fw-bold me-2">{{ crypto.name }}</span>
                  <ng-container *ngIf="getPerformanceBadge(crypto) as badge">
                    <span class="badge {{ badge.class }} me-1" title="{{ badge.label }}">
                      {{ badge.emoji }} {{ badge.label }}
                    </span>
                  </ng-container>

                  <!-- Trade Setup Indicator: Always visible -->
                  <span class="badge cursor-pointer" 
                        (click)="openAnalysisModal(crypto, $event)"
                        [ngClass]="{
                          'bg-success': crypto.tradeSetup?.state === 'bullish', 
                          'bg-danger': crypto.tradeSetup?.state === 'bearish',
                          'bg-secondary': !crypto.tradeSetup?.state
                        }"
                        title="{{ crypto.tradeSetup?.state ? (crypto.tradeSetup?.state === 'bullish' ? 'Bullish Setup Detected' : 'Bearish Setup Detected') : 'No Setup Detected' }}">
                    {{ crypto.tradeSetup?.state ? (crypto.tradeSetup?.state === 'bullish' ? '‚úÖ YES (Bull)' : '‚úÖ YES (Bear)') : '‚ùå NO' }}
                  </span>
                </div>
              </td>
              <td class="fw-semibold">{{ crypto.lastPrice | currency }}</td>
              <td
                [ngClass]="{
                    'green-text': +crypto.priceChangePercent >= 0,
                    'red-text': +crypto.priceChangePercent < 0
                }"
                >
                <span class="arrow-icon">{{ getArrow(crypto.priceChangePercent) }}</span>
                {{ +crypto.priceChangePercent / 100 | percent:'1.2-2' }} 
                <small class="text-muted ms-1">({{ crypto.priceChange | currency }})</small>
              </td>
              <td
                [ngClass]="{
                    'green-text': crypto.dailyChangePercent !== 'N/A' && +crypto.dailyChangePercent >= 0,
                    'red-text': crypto.dailyChangePercent !== 'N/A' && +crypto.dailyChangePercent < 0
                }"
                >
                <span class="arrow-icon">{{ getArrow(crypto.dailyChangePercent) }}</span>
                {{ crypto.dailyChangePercent !== 'N/A' ? (+crypto.dailyChangePercent / 100 | percent:'1.2-2') : 'N/A' }} 
                <small class="text-muted ms-1" *ngIf="crypto.dailyChange !== 'N/A'">({{ crypto.dailyChange | currency }})</small>
              </td>
              <td *ngIf="showPortfolioFeatures" (click)="$event.stopPropagation()">
                <input 
                  type="number" 
                  class="form-control form-control-sm holding-input" 
                  [ngModel]="crypto.holdings" 
                  (ngModelChange)="updateHolding(crypto, $event)"
                  placeholder="0.00"
                  min="0"
                  step="any">
              </td>
              <td *ngIf="showPortfolioFeatures" class="fw-bold">
                {{ (crypto.value || 0) | currency }}
              </td>
              <td (click)="$event.stopPropagation()">
                <button cButton color="warning" variant="ghost" size="sm" (click)="openAlertModal(crypto, $event)" title="Set Price Alert" class="me-1">
                  üîî
                </button>
                <button cButton color="danger" variant="ghost" size="sm" (click)="removeCoin(crypto, $event)" title="Remove coin">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Chart Modal -->
<app-chart-modal 
  *ngIf="selectedCrypto"
  [visible]="chartModalVisible"
  [cryptoSymbol]="selectedCrypto.name"
  [cryptoName]="selectedCrypto.name"
  [currentPrice]="selectedCrypto.lastPrice"
  (visibleChange)="onChartModalVisibleChange($event)">
</app-chart-modal>

<!-- Alert Modal -->
<c-modal [visible]="alertModalVisible" (visibleChange)="alertModalVisible = $event">
  <c-modal-header>
    <h5 cModalTitle>Set Price Alert for {{ alertCrypto?.name }}</h5>
  </c-modal-header>
  <c-modal-body>
    <div class="mb-3">
      <label cLabel>Target Price</label>
      <input cFormControl type="number" [(ngModel)]="alertTargetPrice" placeholder="Enter target price">
    </div>
    <div class="mb-3">
      <label cLabel>Condition</label>
      <select cSelect [(ngModel)]="alertCondition">
        <option value="above">Alert when price goes ABOVE</option>
        <option value="below">Alert when price goes BELOW</option>
      </select>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button (click)="alertModalVisible = false" cButton color="secondary">Cancel</button>
    <button (click)="saveAlert()" cButton color="primary">Set Alert</button>
  </c-modal-footer>
</c-modal>

<!-- News Feed -->
<app-news-feed></app-news-feed>

<!-- Analysis Modal -->
<app-analysis-modal
  [visible]="analysisModalVisible"
  [cryptoName]="selectedAnalysisCryptoName"
  [analysisData]="selectedAnalysisData"
  (visibleChange)="onAnalysisModalVisibleChange($event)">
</app-analysis-modal>